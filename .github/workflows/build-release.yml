name: Build and Release

on:
  push:
    branches: [agent-cli]
    tags: ["v*"]

permissions:
  contents: write

jobs:
  generate-timestamp:
    runs-on: ubuntu-latest
    outputs:
      timestamp: ${{ steps.date.outputs.timestamp }}
    steps:
      - name: Generate timestamp
        id: date
        run: echo "timestamp=$(date -u +%Y%m%d-%H%M)" >> $GITHUB_OUTPUT

  build-windows:
    needs: generate-timestamp
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Update version in version.py
        shell: pwsh
        run: |
          # Determine version based on trigger type
          if ($env:GITHUB_REF.StartsWith("refs/tags/v")) {
            # For tag pushes, use the tag name (remove 'v' prefix)
            $version = $env:GITHUB_REF.Replace("refs/tags/v", "")
          } else {
            # For branch pushes, use date-based build format
            $dateString = Get-Date -Format "yyyyMMdd-HHmm" -AsUTC
            $version = "build-$dateString"
          }

          # Update version.py
          $content = Get-Content "src/version.py" -Raw
          $content = $content -replace '__version__ = "[^"]*"', "__version__ = `"$version`""
          Set-Content "src/version.py" $content

          Write-Host "Updated version to: $version"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build executable with PyInstaller
        run: |
          pyinstaller --clean --noconfirm --log-level WARN api-automation-agent.spec

      - name: Verify executable
        run: |
          if (Test-Path "dist\api-agent.exe") {
            Write-Host "‚úÖ Executable built successfully"
            $size = (Get-Item "dist\api-agent.exe").Length
            Write-Host "üìè Size: $($size / 1MB) MB"
          } else {
            Write-Host "‚ùå Build failed - executable not found"
            exit 1
          }

      - name: Create distribution package
        run: |
          # Create clean distribution folder
          New-Item -ItemType Directory -Path "api-agent-windows" -Force

          # Copy essential files
          Copy-Item "dist\api-agent.exe" "api-agent-windows\"
          Copy-Item "example.env" "api-agent-windows\"
          Copy-Item "USAGE-GUIDE.txt" "api-agent-windows\" -ErrorAction SilentlyContinue

      - name: Create ZIP archive
        run: |
          $timestamp = "${{ needs.generate-timestamp.outputs.timestamp }}"
          $archiveName = "api-agent-windows-$timestamp.zip"
          Compress-Archive -Path "api-agent-windows\*" -DestinationPath $archiveName

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-agent-windows
          path: api-agent-windows-${{ needs.generate-timestamp.outputs.timestamp }}.zip

  build-macos:
    needs: generate-timestamp
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Update version in version.py
        run: |
          # Determine version based on trigger type
          if [[ $GITHUB_REF == refs/tags/v* ]]; then
            # For tag pushes, use the tag name (remove 'v' prefix)
            version=${GITHUB_REF#refs/tags/v}
          else
            # For branch pushes, use date-based build format
            dateString=$(date -u +"%Y%m%d-%H%M")
            version="build-$dateString"
          fi

          # Update version.py
          sed -i.bak "s/__version__ = \"[^\"]*\"/__version__ = \"$version\"/" src/version.py

          echo "Updated version to: $version"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build executable with PyInstaller
        run: |
          pyinstaller --clean --noconfirm --log-level WARN api-automation-agent.spec

      - name: Verify executable
        run: |
          if [ -f "dist/api-agent" ]; then
            echo "‚úÖ Executable built successfully"
            file_size=$(stat -f%z "dist/api-agent" 2>/dev/null || stat -c%s "dist/api-agent" 2>/dev/null)
            echo "üìè Size: $file_size bytes"
          else
            echo "‚ùå Build failed - executable not found"
            exit 1
          fi

      - name: Create distribution package
        run: |
          # Create clean distribution folder
          mkdir -p api-agent-macos

          # Copy essential files
          cp dist/api-agent api-agent-macos/
          cp example.env api-agent-macos/
          cp USAGE-GUIDE.txt api-agent-macos/

      - name: Create TAR.GZ archive
        run: |
          timestamp="${{ needs.generate-timestamp.outputs.timestamp }}"
          archive_name="api-agent-macos-$timestamp.tar.gz"
          tar -czf "$archive_name" -C . api-agent-macos

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-agent-macos
          path: api-agent-macos-${{ needs.generate-timestamp.outputs.timestamp }}.tar.gz

  # Consolidated release job that runs after both builds complete
  create-release:
    needs: [generate-timestamp, build-windows, build-macos]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: api-agent-windows

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: api-agent-macos

      # Create latest release on main branch push
      - name: Create Latest Release
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: api-automation-agent-build-${{ needs.generate-timestamp.outputs.timestamp }}-${{ github.ref_name }}

          name: "API Automation Agent ‚Äî Build ${{ needs.generate-timestamp.outputs.timestamp }} (${{ github.ref_name }})"

          body: |
            ## üöÄ API Automation Agent

            **Auto-generated from commit**

            ### Download Options
            - **Windows**: `api-agent-windows-${{ needs.generate-timestamp.outputs.timestamp }}.zip`
            - **macOS**: `api-agent-macos-${{ needs.generate-timestamp.outputs.timestamp }}.tar.gz`

            ### Quick Start
            1. Download the package for your platform
            3. Run: `./api-agent --help` (Windows & macOS)

            ### Requirements
            - Windows 7+ or macOS 10.14+
            - Node.js (for generated framework execution)
            - Internet connection
            - API key (OpenAI or Anthropic)

            **Build:** ${{ needs.generate-timestamp.outputs.timestamp }}  
            **Branch:** ${{ github.ref_name }}  
            **Commit:** ${{ github.sha }}  
            **Date:** ${{ github.event.head_commit.timestamp }}

            For detailed usage instructions, see the included documentation.
          files: |
            api-agent-windows-${{ needs.generate-timestamp.outputs.timestamp }}.zip
            api-agent-macos-${{ needs.generate-timestamp.outputs.timestamp }}.tar.gz
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Create versioned release on tag push
      - name: Create Versioned Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            api-agent-windows-${{ needs.generate-timestamp.outputs.timestamp }}.zip
            api-agent-macos-${{ needs.generate-timestamp.outputs.timestamp }}.tar.gz
          body: |
            ## üöÄ API Automation Agent Release

            ### What's New
            - Standalone executables for Windows and macOS
            - No Python installation required
            - Includes all dependencies

            ### Download Options
            - **Windows**: `api-agent-windows-${{ needs.generate-timestamp.outputs.timestamp }}.zip`
            - **macOS**: `api-agent-macos-${{ needs.generate-timestamp.outputs.timestamp }}.tar.gz`

            ### Quick Start
            1. Download the package for your platform
            2. Create a `.env` file with your API key  
            3. Run: `./api-agent --help` (Windows & macOS)

            ### Requirements
            - Windows 7+ or macOS 10.14+
            - Node.js (for generated framework execution)
            - Internet connection
            - API key (OpenAI or Anthropic)

            For detailed usage instructions, see the included documentation.
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
